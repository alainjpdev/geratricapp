#!/usr/bin/env node

/**
 * Script para configurar Neon Data API desde la lÃ­nea de comandos
 * 
 * Este script:
 * 1. Verifica si la Data API estÃ¡ habilitada
 * 2. Obtiene el endpoint de la Data API
 * 3. Genera o lista las API keys existentes
 * 4. Actualiza el archivo .env con las credenciales
 * 
 * Requisitos:
 * - Tener neonctl instalado y autenticado
 * - Tener un proyecto de Neon configurado
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');
const envPath = join(projectRoot, '.env');

// Colores para la consola
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function error(message) {
  log(`âŒ Error: ${message}`, 'red');
  process.exit(1);
}

function success(message) {
  log(`âœ… ${message}`, 'green');
}

function info(message) {
  log(`â„¹ï¸  ${message}`, 'blue');
}

function warning(message) {
  log(`âš ï¸  ${message}`, 'yellow');
}

// Obtener informaciÃ³n del proyecto actual
function getProjectInfo() {
  try {
    info('Obteniendo informaciÃ³n del proyecto...');
    const output = execSync('neonctl projects list -o json', { encoding: 'utf-8' });
    const projects = JSON.parse(output);
    
    if (projects.length === 0) {
      error('No se encontraron proyectos. Crea uno primero con: neonctl projects create');
    }
    
    // Usar el primer proyecto o el que estÃ© en el contexto
    const project = projects[0];
    log(`\nProyecto encontrado: ${project.name} (${project.id})`, 'cyan');
    
    return project;
  } catch (err) {
    error(`No se pudo obtener informaciÃ³n del proyecto: ${err.message}`);
  }
}

// Leer archivo .env
function readEnv() {
  if (!existsSync(envPath)) {
    return {};
  }
  
  const content = readFileSync(envPath, 'utf-8');
  const env = {};
  
  content.split('\n').forEach(line => {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const [key, ...valueParts] = trimmed.split('=');
      if (key && valueParts.length > 0) {
        env[key.trim()] = valueParts.join('=').trim().replace(/^["']|["']$/g, '');
      }
    }
  });
  
  return env;
}

// Escribir archivo .env
function writeEnv(env) {
  const lines = [];
  
  // Mantener comentarios y lÃ­neas existentes
  if (existsSync(envPath)) {
    const content = readFileSync(envPath, 'utf-8');
    content.split('\n').forEach(line => {
      const trimmed = line.trim();
      if (trimmed && trimmed.startsWith('#')) {
        lines.push(line);
      }
    });
  }
  
  // Agregar secciÃ³n de Neon Data API
  lines.push('\n# Neon Data API Configuration');
  lines.push('# Generated by setup-neon-data-api.js');
  
  Object.entries(env).forEach(([key, value]) => {
    if (key.startsWith('VITE_NEON_')) {
      lines.push(`${key}="${value}"`);
    }
  });
  
  writeFileSync(envPath, lines.join('\n') + '\n');
}

// FunciÃ³n principal
async function main() {
  log('\nğŸš€ ConfiguraciÃ³n de Neon Data API\n', 'cyan');
  
  // Verificar que neonctl estÃ© instalado
  try {
    execSync('neonctl --version', { stdio: 'ignore' });
  } catch {
    error('neonctl no estÃ¡ instalado. InstÃ¡lalo con: npm install -g neonctl');
  }
  
  // Obtener informaciÃ³n del proyecto
  const project = getProjectInfo();
  
  // Leer .env actual
  const env = readEnv();
  
  log('\nğŸ“‹ Instrucciones para habilitar la Data API:\n', 'yellow');
  log('1. Ve a la consola de Neon: https://console.neon.tech', 'blue');
  log(`2. Selecciona el proyecto: ${project.name}`, 'blue');
  log('3. Navega a "Data API" en el menÃº lateral', 'blue');
  log('4. Haz clic en "Enable" para activar la Data API', 'blue');
  log('5. Copia el endpoint URL que se genera', 'blue');
  log('6. Genera un API Key desde la misma secciÃ³n\n', 'blue');
  
  // Solicitar informaciÃ³n al usuario
  const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
  });
  
  const question = (query) => new Promise((resolve) => {
    readline.question(query, resolve);
  });
  
  try {
    log('Una vez que hayas habilitado la Data API, ingresa la siguiente informaciÃ³n:\n', 'yellow');
    
    const dataApiUrl = await question('Endpoint URL de la Data API: ');
    if (!dataApiUrl.trim()) {
      warning('No se proporcionÃ³ un endpoint URL. Puedes agregarlo manualmente despuÃ©s.');
    }
    
    const apiKey = await question('API Key: ');
    if (!apiKey.trim()) {
      warning('No se proporcionÃ³ un API Key. Puedes agregarlo manualmente despuÃ©s.');
    }
    
    // Actualizar .env
    if (dataApiUrl.trim() || apiKey.trim()) {
      env.VITE_NEON_DATA_API_URL = dataApiUrl.trim() || env.VITE_NEON_DATA_API_URL || '';
      env.VITE_NEON_API_KEY = apiKey.trim() || env.VITE_NEON_API_KEY || '';
      
      writeEnv(env);
      success('Archivo .env actualizado correctamente!');
      
      log('\nğŸ“ Variables agregadas:', 'cyan');
      if (env.VITE_NEON_DATA_API_URL) {
        log(`   VITE_NEON_DATA_API_URL="${env.VITE_NEON_DATA_API_URL}"`, 'green');
      }
      if (env.VITE_NEON_API_KEY) {
        log(`   VITE_NEON_API_KEY="${env.VITE_NEON_API_KEY.substring(0, 10)}..."`, 'green');
      }
      
      log('\nâœ¨ Â¡ConfiguraciÃ³n completada!', 'green');
      log('Reinicia el servidor de desarrollo con: npm run dev\n', 'blue');
    } else {
      warning('No se actualizÃ³ el archivo .env. Agrega las variables manualmente.');
    }
  } finally {
    readline.close();
  }
}

// Ejecutar
main().catch((err) => {
  error(err.message);
});








